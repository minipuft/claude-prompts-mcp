#!/usr/bin/env sh

# Navigate to server directory
cd server

# Contract integrity check: If contracts changed, generated files must also change
CONTRACTS_CHANGED=$(git diff --cached --name-only | grep "tooling/contracts/.*\.json" || true)
GENERATOR_CHANGED=$(git diff --cached --name-only | grep "scripts/generate-contracts\.ts" || true)
GENERATED_CHANGED=$(git diff --cached --name-only | grep "_generated/" || true)

if [ -n "$CONTRACTS_CHANGED" ] && [ -z "$GENERATED_CHANGED" ]; then
  echo ""
  echo "❌ Contract files modified but generated files not updated!"
  echo ""
  echo "Modified contracts:"
  echo "$CONTRACTS_CHANGED"
  echo ""
  echo "Run: npm run generate:contracts"
  echo "Then stage the generated files: git add src/tooling/contracts/_generated/"
  exit 1
fi

# Prevent direct edits to generated TypeScript source files (exclude dist/ build output)
MANUAL_GEN_EDITS=$(git diff --cached --name-only | grep "src/.*_generated/.*\.ts$" || true)
if [ -n "$MANUAL_GEN_EDITS" ]; then
  # Check if contracts or generator were also changed (legitimate regeneration)
  if [ -z "$CONTRACTS_CHANGED" ] && [ -z "$GENERATOR_CHANGED" ]; then
    echo ""
    echo "❌ Direct edits to generated files detected without contract/generator changes!"
    echo ""
    echo "Modified generated files:"
    echo "$MANUAL_GEN_EDITS"
    echo ""
    echo "Edit contracts in tooling/contracts/*.json or scripts/generate-contracts.ts, then run:"
    echo "  npm run generate:contracts"
    exit 1
  fi
fi

# Run lint-staged for formatting (prettier)
npm run -s lint:staged

# Run lint ratchet check (allow existing violations, block new ones)
npm run -s lint:ratchet
if [ $? -ne 0 ]; then
  echo ""
  echo "❌ Lint ratchet check failed - new violations detected!"
  echo "Run: npm run lint:fix to attempt auto-fix"
  exit 1
fi
