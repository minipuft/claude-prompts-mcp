#!/usr/bin/env sh

# Navigate to server directory
cd server

# Contract auto-regeneration: If contracts or generator changed, regenerate and stage
CONTRACTS_CHANGED=$(git diff --cached --name-only | grep "tooling/contracts/.*\.json" || true)
GENERATOR_CHANGED=$(git diff --cached --name-only | grep "scripts/generate-contracts\.ts" || true)

if [ -n "$CONTRACTS_CHANGED" ] || [ -n "$GENERATOR_CHANGED" ]; then
  echo "üìù Contract source changed - auto-regenerating..."
  npm run -s generate:contracts
  if [ $? -ne 0 ]; then
    echo "‚ùå Contract generation failed!"
    exit 1
  fi
  # Stage regenerated files
  git add src/tooling/contracts/_generated/
  echo "‚úÖ Generated files updated and staged"
fi

# Prevent direct edits to generated files (without contract/generator changes)
# Exception: Deletions are allowed if the source contract doesn't exist (feature removal)
MANUAL_GEN_EDITS=$(git diff --cached --name-only | grep "src/.*_generated/.*\.ts$" || true)
if [ -n "$MANUAL_GEN_EDITS" ] && [ -z "$CONTRACTS_CHANGED" ] && [ -z "$GENERATOR_CHANGED" ]; then
  # Check if these are deletions vs modifications
  MODIFIED_GEN_FILES=$(git diff --cached --name-only --diff-filter=M | grep "src/.*_generated/.*\.ts$" || true)
  ADDED_GEN_FILES=$(git diff --cached --name-only --diff-filter=A | grep "src/.*_generated/.*\.ts$" || true)
  DELETED_GEN_FILES=$(git diff --cached --name-only --diff-filter=D | grep "src/.*_generated/.*\.ts$" || true)

  # Block modifications and additions (must go through regeneration)
  if [ -n "$MODIFIED_GEN_FILES" ] || [ -n "$ADDED_GEN_FILES" ]; then
    echo ""
    echo "‚ùå Direct edits to generated files detected!"
    echo ""
    if [ -n "$MODIFIED_GEN_FILES" ]; then
      echo "Modified: $MODIFIED_GEN_FILES"
    fi
    if [ -n "$ADDED_GEN_FILES" ]; then
      echo "Added: $ADDED_GEN_FILES"
    fi
    echo ""
    echo "Edit source files instead:"
    echo "  - tooling/contracts/*.json (contract definitions)"
    echo "  - scripts/generate-contracts.ts (generator logic)"
    echo ""
    echo "Then run: npm run generate:contracts"
    exit 1
  fi

  # Allow deletions - these are valid when removing features/contracts
  if [ -n "$DELETED_GEN_FILES" ]; then
    echo "üìù Generated file deletions detected (feature removal):"
    echo "   $DELETED_GEN_FILES"
    echo "   ‚úÖ Allowed - ensure source contracts were also removed"
  fi
fi

# Run lint-staged for formatting (prettier)
npm run -s lint:staged

# Run lint ratchet check (allow existing violations, block new ones)
npm run -s lint:ratchet
if [ $? -ne 0 ]; then
  echo ""
  echo "‚ùå Lint ratchet check failed - new violations detected!"
  echo "Run: npm run lint:fix to attempt auto-fix"
  exit 1
fi
