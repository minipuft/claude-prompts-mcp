#!/usr/bin/env sh

# Navigate to server directory
cd server || exit 1

echo "üîç Running pre-push validation..."
echo ""

echo "1/6 Type checking..."
npm run typecheck || { echo "‚ùå Type checking failed"; exit 1; }

echo ""
echo "2/6 Linting..."
npm run lint:ratchet || { echo "‚ùå Lint ratchet failed (new violations introduced)"; exit 1; }

echo ""
echo "3/6 Format checking..."
echo "‚úÖ Skipped (format is enforced via eslint/prettier in lint-staged for staged files)"

echo ""
echo "4/6 Running tests..."
npm run test:ci || { echo "‚ùå Tests failed"; exit 1; }

echo ""
echo "5/6 Dependency validation..."
npm run validate:arch || { echo "‚ùå Dependency validation failed"; exit 1; }

echo ""
echo "6/6 Version consistency check..."
npm run validate:versions || { echo "‚ùå Version mismatch across manifests"; exit 1; }

# Optional: render and validate graphs only when .dot sources changed
CHANGED_DOTS=$(git diff --name-only --cached | grep '^server/graphs/.*\.dot$' || true)
if [ -n "$CHANGED_DOTS" ]; then
  echo ""
  echo "Graphs changed; rendering diagrams..."
  (cd .. && npm run graphs:render && npm run graphs:validate) || {
    echo "‚ö†Ô∏è Graph rendering failed or Graphviz missing; skipping"
  }
fi

echo ""
echo "‚úÖ All pre-push validation passed!"
echo ""
