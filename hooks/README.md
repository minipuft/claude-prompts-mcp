# Claude Prompts Hooks

Hooks that guide Claude's behavior when using the prompt engine. These solve common issues where models miss `>>` syntax, forget to continue chains, or skip gate reviews.

## Why Hooks?

| Problem | Hook Solution |
|---------|---------------|
| Model ignores `>>analyze` syntax | `prompt-suggest.py` detects it and suggests the correct MCP call |
| User forgets to continue chain | `post-prompt-engine.py` injects `[Chain] Step 2/5 - call prompt_engine to continue` |
| Gate review skipped | `post-prompt-engine.py` reminds: `[Gate] Respond: GATE_REVIEW: PASS\|FAIL` |
| Session state bloat | `pre-compact.py` cleans up before context compaction |

## Included Hooks

### `prompt-suggest.py` (UserPromptSubmit)

Triggers on every user message. Detects `>>prompt` syntax and injects a system message suggesting the correct `prompt_engine` call with available arguments.

**Example output:**
```
[MCP] >>diagnose (general)
  Args: scope:string, focus:string, symptoms:string
  prompt_engine(command:">>diagnose", options:{...})
```

### `post-prompt-engine.py` (PostToolUse)

Triggers after `prompt_engine` calls. Parses the response to track chain state and pending gates, then injects reminders.

**Example outputs:**
```
[Chain] Step 2/5 - call prompt_engine to continue
[Gate] code-quality
  Respond: GATE_REVIEW: PASS|FAIL - <reason>
```

### `pre-compact.py` (PreCompact)

Triggers before context compaction (`/compact`). Cleans up chain session state to prevent stale data from persisting across compaction boundaries.

### `dev-sync.py` (SessionStart)

Triggers on session start. Uses **quick-check mode** to minimize startup delay:

| Scenario | Time | Action |
|----------|------|--------|
| No changes since last sync | <100ms | Instant skip |
| Source files modified | 2-5s | Full sync |
| First run / marker missing | 2-5s | Full sync + create marker |

**How it works:**
1. Compares source file timestamps against `.dev-sync-marker` in cache
2. If no changes detected, exits immediately (no sync)
3. If changes detected, performs full sync and updates marker

**Force full sync:** Delete `.dev-sync-marker` from the cache directory.

**Note:** Only runs for development setups (source dir exists). Marketplace installs skip this hook entirely.

## Installation

These hooks are included when you install via the Claude Code plugin:

```bash
# First time: add the marketplace
/plugin marketplace add minipuft/minipuft-plugins

# Install the plugin (includes hooks)
/plugin install claude-prompts@minipuft
```

## Architecture

```
hooks/
├── hooks.json            # Hook configuration (matcher → command)
├── prompt-suggest.py     # UserPromptSubmit: syntax detection
├── post-prompt-engine.py # PostToolUse: chain/gate tracking
├── pre-compact.py        # PreCompact: session cleanup
├── dev-sync.py           # SessionStart: quick-check sync (dev only)
├── ralph-stop.py         # Stop: graceful shutdown
├── setup.sh              # Manual: npm install (not auto-run)
└── lib/
    ├── cache_manager.py  # Reads server/cache/prompts.cache.json
    ├── session_state.py  # Chain/gate state tracking
    └── workspace.py      # MCP_WORKSPACE resolution
```

## Configuration

Hooks are configured in `hooks.json`:

```json
{
  "hooks": {
    "UserPromptSubmit": [{
      "matcher": "*",
      "hooks": [{
        "type": "command",
        "command": "python3 ${CLAUDE_PLUGIN_ROOT}/hooks/prompt-suggest.py"
      }]
    }],
    "PostToolUse": [{
      "matcher": "*prompt_engine*",
      "hooks": [{
        "type": "command",
        "command": "python3 ${CLAUDE_PLUGIN_ROOT}/hooks/post-prompt-engine.py"
      }]
    }]
  }
}
```

## Cache Access

Hooks read prompt metadata from `server/cache/prompts.cache.json`, which is generated by the MCP server on startup and updated on hot-reload. This enables `prompt-suggest.py` to show available arguments without calling the server.
