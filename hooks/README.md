# Claude Prompts Hooks

Hooks that guide Claude's behavior when using the prompt engine. These solve common issues where models miss `>>` syntax, forget to continue chains, or skip gate reviews.

## Why Hooks?

| Problem | Hook Solution |
|---------|---------------|
| Model ignores `>>analyze` syntax | `prompt-suggest.py` detects it and suggests the correct MCP call |
| User forgets to continue chain | `post-prompt-engine.py` injects `[Chain] Step 2/5 - call prompt_engine to continue` |
| Gate review skipped | `post-prompt-engine.py` reminds: `[Gate] Respond: GATE_REVIEW: PASS\|FAIL` |
| Session state bloat | `pre-compact.py` cleans up before context compaction |

## Included Hooks

### `prompt-suggest.py` (UserPromptSubmit)

Triggers on every user message. Detects `>>prompt` syntax and injects a system message suggesting the correct `prompt_engine` call with available arguments.

**Example output:**

```
[MCP] >>diagnose (general)
  Args: scope:string, focus:string, symptoms:string
  prompt_engine(command:">>diagnose", options:{...})
```

### `post-prompt-engine.py` (PostToolUse)

Triggers after `prompt_engine` calls. Parses the response to track chain state and pending gates, then injects reminders.

**Example outputs:**

```
[Chain] Step 2/5 - call prompt_engine to continue
[Gate] code-quality
  Respond: GATE_REVIEW: PASS|FAIL - <reason>
```

### `pre-compact.py` (PreCompact)

Triggers before context compaction (`/compact`). Cleans up chain session state to prevent stale data from persisting across compaction boundaries.

### `dev-sync.py` (SessionStart)

Triggers on session start. Syncs source files to the plugin cache.

**Superseded by `--plugin-dir`**: For active development, use Claude Code's direct loading:

```bash
cc --plugin-dir /path/to/claude-prompts
```

This bypasses the cache entirely, making dev-sync unnecessary. The hook remains for:

- Users who prefer marketplace install + automatic sync
- Fallback when `--plugin-dir` is forgotten

**Quick-check mode** minimizes startup delay:

| Scenario | Time | Action |
|----------|------|--------|
| No changes since last sync | <100ms | Instant skip |
| Source files modified | 2-5s | Full sync |
| First run / marker missing | 2-5s | Full sync + create marker |

## Installation

These hooks are included when you install via the Claude Code plugin:

```bash
# First time: add the marketplace
/plugin marketplace add minipuft/minipuft-plugins

# Install the plugin (includes hooks)
/plugin install claude-prompts@minipuft
```

## Architecture

```
hooks/
├── hooks.json              # Claude Code hooks config
├── prompt-suggest.py       # UserPromptSubmit (syntax detection)
├── post-prompt-engine.py   # PostToolUse (chain/gate tracking)
├── pre-compact.py          # PreCompact (session cleanup)
├── dev-sync.py             # SessionStart (quick-check sync)
├── ralph-stop.py           # Stop (graceful shutdown)
├── setup.sh                # Manual: npm install (not auto-run)
└── lib/                    # Shared utilities
    ├── cache_manager.py    # Reads server/cache/prompts.cache.json
    ├── session_state.py    # Chain/gate state tracking
    └── workspace.py        # MCP_WORKSPACE resolution
```

## Configuration

Claude Code hooks are configured in `hooks/hooks.json`:

```json
{
  "hooks": {
    "UserPromptSubmit": [{
      "matcher": "*",
      "hooks": [{
        "type": "command",
        "command": "python3 ${CLAUDE_PLUGIN_ROOT}/hooks/prompt-suggest.py"
      }]
    }],
    "PostToolUse": [{
      "matcher": "*prompt_engine*",
      "hooks": [{
        "type": "command",
        "command": "python3 ${CLAUDE_PLUGIN_ROOT}/hooks/post-prompt-engine.py"
      }]
    }]
  }
}
```

## Cache Access

Hooks read prompt metadata from `server/cache/prompts.cache.json`, which is generated by the MCP server on startup and updated on hot-reload. This enables `prompt-suggest.py` to show available arguments without calling the server.

---

## Shared Utilities (`lib/`)

The `lib/` directory contains shared utilities used by hooks. These are also available to downstream projects (like gemini-prompts) via the dist branch submodule.

| Module | Purpose |
|--------|---------|
| `cache_manager.py` | Read prompt cache, match prompts to intent |
| `session_state.py` | Chain/gate state tracking |
| `workspace.py` | MCP_WORKSPACE resolution |

---

## Other Platforms

For Gemini CLI hooks, see [gemini-prompts/hooks/](https://github.com/minipuft/gemini-prompts/tree/main/hooks). Gemini hooks are maintained separately but share the `lib/` utilities via submodule.
