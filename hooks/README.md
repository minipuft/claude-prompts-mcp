# Claude Prompts Hooks

Hooks that guide Claude's behavior when using the prompt engine. These solve common issues where models miss `>>` syntax, forget to continue chains, or skip gate reviews.

## Why Hooks?

| Problem | Hook Solution |
|---------|---------------|
| Model ignores `>>analyze` syntax | `prompt-suggest.py` detects it and suggests the correct MCP call |
| User forgets to continue chain | `post-prompt-engine.py` injects `[Chain] Step 2/5 - call prompt_engine to continue` |
| Gate review skipped | `post-prompt-engine.py` reminds: `[Gate] Respond: GATE_REVIEW: PASS\|FAIL` |
| Gate FAIL verdict ignored | `gate-enforce.py` blocks execution until criteria addressed |
| Session state bloat | `pre-compact.py` cleans up before context compaction |

## Included Hooks

### `prompt-suggest.py` (UserPromptSubmit)

Triggers on every user message. Detects `>>prompt` syntax and injects a system message suggesting the correct `prompt_engine` call with available arguments.

**Example output:**

```
[MCP] >>diagnose (general)
  Args: scope:string, focus:string, symptoms:string
  prompt_engine(command:">>diagnose", options:{...})
```

### `post-prompt-engine.py` (PostToolUse)

Triggers after `prompt_engine` calls. Parses the response to track chain state and pending gates, then injects reminders.

**Example outputs:**

```
[Chain] Step 2/5 - call prompt_engine to continue
[Gate] code-quality
  Respond: GATE_REVIEW: PASS|FAIL - <reason>
```

### `pre-compact.py` (PreCompact)

Triggers before context compaction (`/compact`). Cleans up chain session state to prevent stale data from persisting across compaction boundaries.

### `gate-enforce.py` (PreToolUse)

Triggers before `prompt_engine` calls. Enforces gate review discipline by blocking:

1. **FAIL verdicts without retry** - Guides Claude to address gate criteria before proceeding
2. **Missing gate_verdict** - Requires explicit PASS/FAIL when resuming chains with pending gates
3. **Missing user_response** - Ensures chain resumes include completed work

**Example denial:**

```
Gate failed: code has security issues. Review the gate criteria and retry with improvements.
Resubmit with GATE_REVIEW: PASS once criteria are met.
```

## Installation

These hooks are included when you install via the Claude Code plugin:

```bash
# First time: add the marketplace
/plugin marketplace add minipuft/minipuft-plugins

# Install the plugin (includes hooks)
/plugin install claude-prompts@minipuft
```

## Architecture

```
hooks/
├── hooks.json              # Claude Code hooks config
├── prompt-suggest.py       # UserPromptSubmit (syntax detection)
├── gate-enforce.py         # PreToolUse (gate verdict enforcement)
├── post-prompt-engine.py   # PostToolUse (chain/gate tracking)
├── pre-compact.py          # PreCompact (session cleanup)
├── ralph-stop.py           # Stop (graceful shutdown)
└── lib/                    # Shared utilities
    ├── cache_manager.py    # Reads server/cache/prompts.cache.json
    ├── session_state.py    # Chain/gate state tracking
    └── workspace.py        # MCP_WORKSPACE resolution
```

## Configuration

Claude Code hooks are configured in `hooks/hooks.json`:

```json
{
  "hooks": {
    "UserPromptSubmit": [{
      "matcher": "*",
      "hooks": [{
        "type": "command",
        "command": "python3 ${CLAUDE_PLUGIN_ROOT}/hooks/prompt-suggest.py"
      }]
    }],
    "PostToolUse": [{
      "matcher": "*prompt_engine*",
      "hooks": [{
        "type": "command",
        "command": "python3 ${CLAUDE_PLUGIN_ROOT}/hooks/post-prompt-engine.py"
      }]
    }]
  }
}
```

### Server Configuration

Hook behavior can be customized in `server/config.json`:

```json
{
  "hooks": {
    "expandedOutput": false
  }
}
```

| Setting | Default | Description |
|---------|---------|-------------|
| `expandedOutput` | `false` | Show detailed multi-line output instead of compact single-line |

**Compact mode** (default):
```
[>>] diagnose | scope:"auth" [chain:3steps, @CAGEERF]
```

**Expanded mode** (`expandedOutput: true`):
```
[MCP] >>diagnose
  Operators: chain (3 steps) | @CAGEERF
  Arguments: scope: string (required), focus: string (optional)
  Provided: scope="auth"
```

## Cache Access

Hooks read prompt metadata from `server/cache/prompts.cache.json`, which is generated by the MCP server on startup and updated on hot-reload. This enables `prompt-suggest.py` to show available arguments without calling the server.

---

## Shared Utilities (`lib/`)

The `lib/` directory contains shared utilities used by hooks. These are also available to downstream projects (like gemini-prompts) via the dist branch submodule.

| Module | Purpose |
|--------|---------|
| `cache_manager.py` | Read prompt cache, match prompts to intent |
| `session_state.py` | Chain/gate state tracking |
| `workspace.py` | MCP_WORKSPACE resolution |

---

## Other Platforms

For Gemini CLI hooks, see [gemini-prompts/hooks/](https://github.com/minipuft/gemini-prompts/tree/main/hooks). Gemini hooks are maintained separately but share the `lib/` utilities via submodule.
