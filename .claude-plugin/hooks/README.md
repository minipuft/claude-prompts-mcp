# Claude Prompts MCP Hooks

Claude Code hooks that enhance the MCP server experience with context injection, chain tracking, and quality gates.

## Installation

These hooks are automatically installed with the plugin:

```bash
/install-plugin minipuft/claude-prompts-mcp
```

## Available Hooks

| Hook | Event | Purpose |
|------|-------|---------|
| `detect-skills.py` | SessionStart | Detects relevant skills for current project |
| `dev-sync.py` | SessionStart | Syncs plugin source to cache (dev mode only) |
| `prompt-suggest.py` | UserPromptSubmit | Provides prompt suggestions and chain guidance |
| `post-prompt-engine.py` | PostToolUse | Tracks chain state and gate responses |
| `plan-review.py` | PreToolUse | Injects reflection criteria before ExitPlanMode |

## Hook Behaviors

### `detect-skills.py` (SessionStart)

Parses `skills/_index.json` and detects which skills are relevant based on:
- Project markers (files like `package.json`, `tsconfig.json`)
- Directory patterns (e.g., `spicetify-*`, `mcp-*`)
- Package dependencies

**Output**: `[Skills] typescript, react, mcp-patterns`

### `prompt-suggest.py` (UserPromptSubmit)

Detects prompt-related syntax and provides context:

| Syntax | Detection | Output |
|--------|-----------|--------|
| `>>prompt_id` | Direct invocation | Args, tool call, category |
| `>>a --> >>b` | Chain syntax | Full chain command |
| `:: 'criteria'` | Inline gates | Gate reminder, verdict format |

**Example**:
```
User: >>deep_analysis

[MCP] >>deep_analysis (analysis)
  Args: topic*:string, depth:string
  prompt_engine(command:">>deep_analysis", options:{"topic": "<topic>"})
```

### `post-prompt-engine.py` (PostToolUse)

Tracks chain and gate state from `prompt_engine` responses:
- Current chain step progress
- Pending gate validations
- Continuation reminders

**Example**:
```
[Gate] code-quality
  Respond: GATE_REVIEW: PASS|FAIL - <reason>
  Check: No hardcoded secrets | All functions documented
```

### `plan-review.py` (PreToolUse)

One-time reflection gate before `ExitPlanMode`:
- Blocks first call to inject reflection criteria
- Subsequent calls pass through
- Forces risk assessment and completeness check

## Cache System

Hooks use a local cache at `server/cache/prompts-index.json` for fast lookups:

```json
{
  "prompts": {
    "prompt_id": {
      "description": "...",
      "category": "analysis",
      "arguments": [...],
      "is_chain": false
    }
  },
  "generated_at": "2025-01-02T..."
}
```

The cache is auto-generated by the MCP server on startup and hot-reloaded when prompts change.

## Library Modules

### `lib/cache_manager.py`

Loads and queries the prompts cache:
- `load_prompts_cache()` - Load cache from file
- `get_prompt_by_id(id, cache)` - Get specific prompt info
- `match_prompts_to_intent(query, cache)` - Fuzzy match prompts
- `get_chains_only(cache)` - Filter to chain prompts

### `lib/session_state.py`

Manages chain/gate state across hook invocations:
- `load_session_state(session_id)` - Get current state
- `save_session_state(session_id, state)` - Persist state
- `parse_prompt_engine_response(content)` - Extract chain/gate info
- `format_chain_reminder(state)` - Format continuation prompt

### `lib/workspace.py`

Resolves workspace paths with priority:
1. `MCP_WORKSPACE` environment variable
2. `CLAUDE_PLUGIN_ROOT` environment variable
3. User fallback (`~/.claude/...`)

## Environment Variables

| Variable | Used By | Purpose |
|----------|---------|---------|
| `CLAUDE_PLUGIN_ROOT` | All hooks | Plugin installation directory |
| `MCP_WORKSPACE` | workspace.py | Custom workspace override |

## Development

### Testing Hooks Locally

```bash
# Test detect-skills
echo '{}' | python3 hooks/detect-skills.py

# Test prompt-suggest with input
echo '{"prompt": ">>deep_analysis"}' | python3 hooks/prompt-suggest.py
```

### Adding New Hooks

1. Create `hooks/your-hook.py`
2. Add entry to `hooks/hooks.json`:
   ```json
   {
     "EventName": [{
       "matcher": "*",
       "hooks": [{
         "type": "command",
         "command": "python3 ${CLAUDE_PLUGIN_ROOT}/hooks/your-hook.py"
       }]
     }]
   }
   ```
3. Test locally, then sync to cache

## Troubleshooting

**Hooks not running?**
- Check `~/.claude/settings.json` has plugin enabled
- Verify `CLAUDE_PLUGIN_ROOT` is set
- Check hook exit codes (0 = success, 2 = block with message)

**Cache not found?**
- Ensure MCP server is running
- Check `server/cache/prompts-index.json` exists
- Restart server to regenerate cache
