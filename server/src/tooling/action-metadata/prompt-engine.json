{
  "tool": "prompt_engine",
  "version": 2,
  "notes": [
    "Parameters sourced from McpToolRequest interface.",
    "Command routing issue reproduced with command string '>>listprompts'.",
    "Use this data to seed telemetry and guide flows."
  ],
  "issues": [
    {
      "severity": "warning",
      "summary": "Custom quality gates not rendered",
      "details": "quality_gates parameter accepts IDs but GateEnhancement output omits them."
    },
    {
      "severity": "warning",
      "summary": "custom_checks invisible",
      "details": "custom_checks payload is accepted yet never surfaced in quality guidance."
    },
    {
      "severity": "warning",
      "summary": "Framework state drift",
      "details": "Some execution contexts ignore system_control framework selection; verify injection stage."
    },
    {
      "severity": "warning",
      "summary": "execution_mode override",
      "details": "Requests that set execution_mode may still run semantic detection, ignoring override."
    }
  ],
  "parameters": [
    {
      "name": "command",
      "status": "working",
      "description": "Primary execution command (>>prompt, chain://, JSON payloads)."
    },
    {
      "name": "session_id",
      "status": "deprecated",
      "description": "Legacy resume identifier; validator rejects usage.",
      "issues": [
        {
          "severity": "info",
          "summary": "Explicitly blocked",
          "details": "Validator throws with guidance to use chain_id instead."
        }
      ]
    },
    {
      "name": "chain_id",
      "status": "untested",
      "description": "Canonical chain identifier (chain-<prompt>#run).",
      "issues": [
        {
          "severity": "info",
          "summary": "Resume path not validated",
          "details": "Need reproducible scenario proving resume flows succeed when ID provided."
        }
      ]
    },
    {
      "name": "gate_verdict",
      "status": "working",
      "description": "Use this to resume after manual gate review (send GATE_REVIEW: PASS/FAIL here while keeping user_response for actual step output)."
    },
    {
      "name": "user_response",
      "status": "working",
      "description": "Response payload for ongoing chain sessions."
    },
    {
      "name": "force_restart",
      "status": "untested",
      "description": "Forces chain sessions to restart from step 1.",
      "issues": [
        {
          "severity": "info",
          "summary": "Requires confirmation",
          "details": "Flag is parsed but not covered by tests; telemetry needed."
        }
      ]
    },
    {
      "name": "execution_mode",
      "status": "needs-validation",
      "description": "Force how the pipeline executes when semantic detection guesses wrong (prompt/template/chain/auto).",
      "issues": [
        {
          "severity": "warning",
          "summary": "Override ignored",
          "details": "Requests that set execution_mode may still run semantic detection, ignoring override."
        }
      ]
    },
    {
      "name": "api_validation",
      "status": "needs-validation",
      "description": "Opt-in API handshake for manual reviews. When true, responses include gate_verdict reminders instead of forcing retries."
    },
    {
      "name": "quality_gates",
      "status": "display-gap",
      "description": "List of gate IDs to include explicitly.",
      "issues": [
        {
          "severity": "warning",
          "summary": "Not reflected in output",
          "details": "Parameter accepted but GateEnhancement output omits requested gates."
        }
      ]
    },
    {
      "name": "custom_checks",
      "status": "display-gap",
      "description": "Array of custom validation checks.",
      "issues": [
        {
          "severity": "warning",
          "summary": "Not visible",
          "details": "Accepted payload never appears in quality guidance."
        }
      ]
    },
    {
      "name": "gate_scope",
      "status": "untested",
      "description": "Controls how long gate validation applies (execution | session | chain | step).",
      "issues": [
        {
          "severity": "info",
          "summary": "Field never surfaced",
          "details": "Schema accepts the field but runtime never echoes it back or documents defaults."
        }
      ]
    },
    {
      "name": "temporary_gates",
      "status": "untested",
      "description": "Inline gate definitions (id + criteria + severity). If the ID matches an existing quality gate, it reuses that gate automatically.",
      "issues": [
        {
          "severity": "warning",
          "summary": "Structure unclear",
          "details": "Full gate definition accepted but never referenced in Stage 5 output."
        }
      ]
    },
    {
      "name": "timeout",
      "status": "working",
      "description": "Optional execution timeout override in milliseconds."
    },
    {
      "name": "options",
      "status": "working",
      "description": "Bag of execution-specific options forwarded downstream."
    }
  ],
  "commands": [
    {
      "id": ">>listprompts",
      "status": "routing_issue",
      "description": "Should list prompts but instead attempts to execute a prompt with ID 'listprompts'.",
      "issues": [
        {
          "severity": "high",
          "summary": "Misrouted command",
          "details": "Command hits prompt execution path, returning 'No prompts found' instead of enumerating prompts."
        }
      ]
    }
  ],
  "usagePatterns": [
    {
      "id": "gate-controls",
      "title": "Gate Controls + Temporary Gates",
      "summary": "Combine api_validation, reusable quality gates, inline custom checks, and temporary gate definitions in a single run.",
      "sampleCommand": "prompt_engine({\n  \"command\": \">>prompt security-review\",\n  \"api_validation\": true,\n  \"quality_gates\": [\"toxicity\", \"traceability\"],\n  \"custom_checks\": [{ \"name\": \"red-team\", \"description\": \"Confirm exfil path\" }],\n  \"temporary_gates\": [{ \"id\": \"temp-gdpr\", \"criteria\": [\"no PII\"], \"severity\": \"high\" }],\n  \"gate_scope\": \"execution\"\n})",
      "parameters": [
        "command",
        "api_validation",
        "quality_gates",
        "custom_checks",
        "temporary_gates",
        "gate_scope"
      ],
      "notes": [
        "Temporary gates follow the same schema as canonical GateRegistry entries and reuse built-in gates automatically when IDs match.",
        "Gate scope controls whether validation stays execution-local or follows the chain."
      ]
    },
    {
      "id": "chain-resume",
      "title": "Chain Resume & Restart",
      "summary": "Resume an interrupted chain with chain_id, feed a user response, or force a restart from the first step.",
      "sampleCommand": "prompt_engine({\n  \"command\": \">>prompt chain://threat-model#step-3\",\n  \"chain_id\": \"chain-threat-model#3\",\n  \"user_response\": \"Proceed with mitigations A and B.\",\n  \"force_restart\": false\n})",
      "parameters": [
        "command",
        "chain_id",
        "user_response",
        "force_restart"
      ],
      "notes": [
        "Use gate_verdict when resuming after manual reviews.",
        "Setting force_restart:true ignores previously cached steps even if chain_id is present."
      ]
    },
    {
      "id": "prompt-catalog",
      "title": "Prompt Catalog Discovery",
      "summary": "Route list commands back to the prompt manager for semantic filtering, even when invoked from prompt engine.",
      "sampleCommand": "prompt_engine({\n  \"command\": \">>listprompts security audits\"\n})",
      "parameters": [
        "command"
      ],
      "notes": [
        "Routing pattern handled before prompt execution; falls back to in-memory catalog if prompt_manager is offline.",
        "Use search terms after >>listprompts to limit results (e.g., `>>listprompts security`)."
      ]
    },
    {
      "id": "execution-mode",
      "title": "Execution Mode Overrides + Timeouts",
      "summary": "Pin execution_mode to prompt/template/chain, set explicit timeouts, and relay tool-specific options in one payload.",
      "sampleCommand": "prompt_engine({\n  \"command\": \">>prompt system-hardening-plan\",\n  \"execution_mode\": \"chain\",\n  \"force_restart\": true,\n  \"timeout\": 180000,\n  \"options\": { \"context\": \"prod-cluster-7\", \"telemetry\": true }\n})",
      "parameters": [
        "command",
        "execution_mode",
        "force_restart",
        "timeout",
        "options"
      ],
      "notes": [
        "execution_mode defaults to auto (semantic detection) when omitted.",
        "Timeouts apply to the full pipeline; upstream transports may impose stricter caps."
      ]
    }
  ]
}
