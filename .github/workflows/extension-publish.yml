name: Publish Extensions

on:
  # Trigger after npm-publish workflow completes successfully
  workflow_run:
    workflows: ["Publish to npm"]
    types: [completed]
  # Manual trigger for testing (bypasses npm dependency)
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 1.1.0)'
        required: true
        type: string

permissions:
  contents: write  # Needed to upload release assets

jobs:
  # Build and attach Desktop Extension (.mcpb) to release
  desktop-extension:
    # Run if: npm-publish succeeded OR manual trigger
    if: >-
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
      || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          # For workflow_run: use the branch/tag from the triggering workflow
          # For workflow_dispatch: use current ref
          ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || github.ref }}

      - uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: npm
          cache-dependency-path: server/package-lock.json

      - name: Extract version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            # Extract version from head_branch (tag name) or package.json
            # Supports both 'vX.Y.Z' (current) and 'claude-prompts-vX.Y.Z' (legacy)
            branch='${{ github.event.workflow_run.head_branch }}'
            if [[ "$branch" =~ ^v([0-9]+\.[0-9]+\.[0-9]+) ]]; then
              version="${BASH_REMATCH[1]}"
            elif [[ "$branch" =~ ^claude-prompts-v([0-9]+\.[0-9]+\.[0-9]+) ]]; then
              version="${BASH_REMATCH[1]}"
            else
              # Fallback: read from package.json
              version=$(node -p "require('./server/package.json').version")
            fi
            echo "version=$version" >> $GITHUB_OUTPUT
          fi

      - name: Validate required files
        run: |
          echo "Validating required files for Desktop extension..."
          required_files="manifest.json .mcpbignore"
          for file in $required_files; do
            if [[ ! -f "$file" ]]; then
              echo "ERROR: Missing required file: $file"
              exit 1
            fi
            echo "  ✓ $file exists"
          done
          echo "All required files present."

      - name: Install server dependencies
        working-directory: server
        run: npm ci

      - name: Build server
        working-directory: server
        run: npm run build

      - name: Build Desktop Extension (.mcpb)
        run: |
          chmod +x scripts/build-extension.sh
          ./scripts/build-extension.sh

      - name: Rename with version
        run: |
          mv claude-prompts.mcpb claude-prompts-${{ steps.version.outputs.version }}.mcpb

      - name: Upload to Release
        if: github.event_name == 'workflow_run'
        uses: softprops/action-gh-release@v2
        with:
          files: claude-prompts-${{ steps.version.outputs.version }}.mcpb
          # Match Release Please tag format (include-component-in-tag: false)
          tag_name: v${{ steps.version.outputs.version }}

      - name: Upload Artifact (workflow_dispatch)
        if: github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v6
        with:
          name: claude-prompts-${{ steps.version.outputs.version }}.mcpb
          path: claude-prompts-${{ steps.version.outputs.version }}.mcpb

  plugin-dist:
    if: >-
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
      || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      version: ${{ steps.version.outputs.version }}
      artifact-name: dist-runtime-${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || github.ref }}

      - uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: npm
          cache-dependency-path: server/package-lock.json

      - name: Extract version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            # Supports both 'vX.Y.Z' (current) and 'claude-prompts-vX.Y.Z' (legacy)
            branch='${{ github.event.workflow_run.head_branch }}'
            if [[ "$branch" =~ ^v([0-9]+\.[0-9]+\.[0-9]+) ]]; then
              version="${BASH_REMATCH[1]}"
            elif [[ "$branch" =~ ^claude-prompts-v([0-9]+\.[0-9]+\.[0-9]+) ]]; then
              version="${BASH_REMATCH[1]}"
            else
              version=$(node -p "require('./server/package.json').version")
            fi
            echo "version=$version" >> $GITHUB_OUTPUT
          fi

      - name: Validate required files
        run: |
          echo "Validating required files for dist publish..."
          required_files=".claude-plugin/plugin.json .mcp.json"
          for file in $required_files; do
            if [[ ! -f "$file" ]]; then
              echo "ERROR: Missing required file: $file"
              exit 1
            fi
            echo "  ✓ $file exists"
          done
          echo "All required files present."

      - name: Install and build server
        working-directory: server
        run: |
          npm ci
          npm run build

      - name: Stage dist plugin tree
        run: |
          set -euo pipefail
          STAGING_DIR="$RUNNER_TEMP/dist-staging"
          rm -rf "$STAGING_DIR"
          mkdir -p "$STAGING_DIR/server"
          cp -r .claude-plugin "$STAGING_DIR/"
          cp .mcp.json "$STAGING_DIR/"
          cp -r skills "$STAGING_DIR/" 2>/dev/null || true
          cp -r hooks "$STAGING_DIR/" 2>/dev/null || true
          cp -r server/dist "$STAGING_DIR/server/"
          cp -r server/resources "$STAGING_DIR/server/"
          cp server/config.json "$STAGING_DIR/server/"
          cp -r server/cache "$STAGING_DIR/server/" 2>/dev/null || true
          tar -czf "$RUNNER_TEMP/dist-runtime.tar.gz" -C "$STAGING_DIR" .

      - name: Validate dist artifact
        run: |
          set -euo pipefail
          VERIFY_DIR="$RUNNER_TEMP/dist-verify"
          rm -rf "$VERIFY_DIR"
          mkdir -p "$VERIFY_DIR"
          tar -xzf "$RUNNER_TEMP/dist-runtime.tar.gz" -C "$VERIFY_DIR"
          test -f "$VERIFY_DIR/server/dist/index.js"
          test -f "$VERIFY_DIR/server/config.json"
          test -d "$VERIFY_DIR/server/resources"
          test -f "$VERIFY_DIR/.mcp.json"
          test -f "$VERIFY_DIR/.claude-plugin/plugin.json"

      - name: Upload dist artifact
        uses: actions/upload-artifact@v6
        with:
          name: dist-runtime-${{ steps.version.outputs.version }}
          path: ${{ runner.temp }}/dist-runtime.tar.gz

  publish-dist:
    if: >-
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
      || github.event_name == 'workflow_dispatch'
    needs: plugin-dist
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || github.ref }}

      - name: Download dist artifact
        uses: actions/download-artifact@v6
        with:
          name: dist-runtime-${{ needs.plugin-dist.outputs.version }}
          path: ${{ runner.temp }}/dist-artifact

      - name: Publish dist branch
        run: |
          set -euo pipefail
          ARTIFACT="$RUNNER_TEMP/dist-artifact/dist-runtime.tar.gz"
          UNPACKED="$RUNNER_TEMP/dist-unpacked"
          rm -rf "$UNPACKED"
          mkdir -p "$UNPACKED"
          tar -xzf "$ARTIFACT" -C "$UNPACKED"

          git checkout --orphan dist
          git rm -rf . >/dev/null 2>&1 || true
          git clean -fdx
          cp -r "$UNPACKED"/. .

          test -f server/dist/index.js
          test -f server/config.json
          test -d server/resources
          test -f .mcp.json
          test -f .claude-plugin/plugin.json

          if [ -d .github ] || [ -d .claude ] || [ -d docs ] || [ -d server/src ] || [ -d server/tests ]; then
            echo "ERROR: dist branch includes source-only paths."
            exit 1
          fi

          git add -A
          if git diff --cached --quiet; then
            echo "No changes to publish."
            exit 0
          fi
          git -c user.name="github-actions[bot]" -c user.email="41898282+github-actions[bot]@users.noreply.github.com" commit -m "chore: publish dist ${{ needs.plugin-dist.outputs.version }}"
          git push origin dist --force

  validate-distribution:
    if: >-
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
      || github.event_name == 'workflow_dispatch'
    needs: publish-dist
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || github.ref }}

      - uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: npm
          cache-dependency-path: server/package-lock.json

      - name: Validate distribution versions
        working-directory: server
        run: node scripts/validate-versions.js --distribution --skip-npm

  # Build Claude Code plugin archive (manual only)
  claude-code-plugin:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || github.ref }}

      - uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: npm
          cache-dependency-path: server/package-lock.json

      - name: Extract version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            # Supports both 'vX.Y.Z' (current) and 'claude-prompts-vX.Y.Z' (legacy)
            branch='${{ github.event.workflow_run.head_branch }}'
            if [[ "$branch" =~ ^v([0-9]+\.[0-9]+\.[0-9]+) ]]; then
              version="${BASH_REMATCH[1]}"
            elif [[ "$branch" =~ ^claude-prompts-v([0-9]+\.[0-9]+\.[0-9]+) ]]; then
              version="${BASH_REMATCH[1]}"
            else
              version=$(node -p "require('./server/package.json').version")
            fi
            echo "version=$version" >> $GITHUB_OUTPUT
          fi

      - name: Validate required files
        run: |
          echo "Validating required files for Claude Code plugin..."
          required_files=".claude-plugin/plugin.json .mcp.json"
          for file in $required_files; do
            if [[ ! -f "$file" ]]; then
              echo "ERROR: Missing required file: $file"
              exit 1
            fi
            echo "  ✓ $file exists"
          done
          echo "All required files present."

      - name: Install and build server
        working-directory: server
        run: |
          npm ci
          npm run build

      - name: Create plugin archive
        run: |
          set -euo pipefail
          mkdir -p .plugin-staging

          # Copy plugin manifest and config
          cp -r .claude-plugin .plugin-staging/
          cp .mcp.json .plugin-staging/

          # Copy skills and hooks
          cp -r skills .plugin-staging/ 2>/dev/null || true
          cp -r hooks .plugin-staging/ 2>/dev/null || true

          # Copy server (bundled - no node_modules needed)
          mkdir -p .plugin-staging/server
          cp -r server/dist .plugin-staging/server/
          cp -r server/resources .plugin-staging/server/
          cp server/config.json .plugin-staging/server/
          cp -r server/cache .plugin-staging/server/ 2>/dev/null || true

          # Validate staged runtime
          test -f .plugin-staging/server/dist/index.js
          test -f .plugin-staging/server/config.json
          test -d .plugin-staging/server/resources

          # Create archive
          cd .plugin-staging
          zip -r ../claude-prompts-plugin-${{ steps.version.outputs.version }}.zip .
          cd ..

      - name: Upload to Release
        if: github.event_name == 'workflow_run'
        uses: softprops/action-gh-release@v2
        with:
          files: claude-prompts-plugin-${{ steps.version.outputs.version }}.zip
          # Match Release Please tag format (include-component-in-tag: false)
          tag_name: v${{ steps.version.outputs.version }}

      - name: Upload Artifact (workflow_dispatch)
        if: github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v6
        with:
          name: claude-prompts-plugin-${{ steps.version.outputs.version }}.zip
          path: claude-prompts-plugin-${{ steps.version.outputs.version }}.zip

  # NOTE: Gemini CLI extension and OpenCode plugin are maintained in separate repositories:
  # - https://github.com/minipuft/gemini-prompts
  # - https://github.com/minipuft/opencode-prompts
  # Both use claude-prompts as an npm dependency (^1.x semver range).
  # Dependabot creates weekly PRs to update the explicit version in package.json.
