name: Publish to npm

on:
  release:
    types: [published]

# OIDC Trusted Publishing - no NPM_TOKEN needed
# Setup required on npmjs.com:
#   1. Go to https://www.npmjs.com/package/claude-prompts/access
#   2. Add Trusted Publisher → GitHub Actions
#   3. Configure: minipuft / claude-prompts / npm-publish.yml / npm

permissions:
  contents: read
  id-token: write # Required for OIDC trusted publishing

jobs:
  publish:
    # Accept only tag format: 'vX.Y.Z'
    if: startsWith(github.event.release.tag_name, 'v')
    runs-on: ubuntu-latest
    environment: npm
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.tag_name }}

      - uses: actions/setup-node@v6
        with:
          node-version: 24
          registry-url: https://registry.npmjs.org
          cache: npm
          cache-dependency-path: server/package-lock.json

      - name: Parse version from tag
        id: version
        run: |
          tag='${{ github.event.release.tag_name }}'
          if [[ "$tag" =~ ^v([0-9]+\.[0-9]+\.[0-9]+.*)$ ]]; then
            version="${BASH_REMATCH[1]}"
          else
            echo "::error::Unexpected tag format: $tag"
            exit 1
          fi
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "Parsed version: $version"

      - name: Verify version alignment
        run: |
          pkg_version="$(node -p "require('./server/package.json').version")"
          tag_version="${{ steps.version.outputs.version }}"

          if [[ "$pkg_version" != "$tag_version" ]]; then
            echo "::error::Version mismatch - tag: $tag_version, package.json: $pkg_version"
            exit 1
          fi

          echo "✅ Version aligned: $tag_version"

      - name: Verify changelog entry
        run: |
          version="${{ steps.version.outputs.version }}"
          if ! grep -q "## \\[${version}\\]" CHANGELOG.md; then
            echo "::error::Missing changelog entry for $version"
            exit 1
          fi
          echo "✅ Changelog entry found for $version"

      - name: Install dependencies
        working-directory: server
        run: npm ci

      - name: Build
        working-directory: server
        run: npm run build

      - name: Test
        working-directory: server
        run: npm run test:ci

      - name: Publish to npm (OIDC Trusted Publishing)
        working-directory: server
        run: |
          echo "Publishing claude-prompts@${{ steps.version.outputs.version }} via OIDC"
          # OIDC trusted publishing - no token needed, provenance auto-enabled
          npm publish --access public --provenance

      # Downstream updates handled by Dependabot in each repo
      # - gemini-prompts: dependabot watches claude-prompts weekly
      # - opencode-prompts: dependabot watches claude-prompts weekly

      - name: Summary
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## npm Publish" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ job.status }}" == "success" ]]; then
            echo "✅ Published claude-prompts@${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
            echo "[View on npm](https://www.npmjs.com/package/claude-prompts)" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Publish failed" >> $GITHUB_STEP_SUMMARY
          fi
